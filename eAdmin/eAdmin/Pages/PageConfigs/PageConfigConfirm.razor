@page "/config/confirm/{project_id}/{server_id}"
@layout BlankLayout
  @inject IHttpService  http;
@inject NavigationManager nav;
@inject IStringLocalizer<Resource> lang

@inject ISnackbar toast;

<Loading is_loading="@is_loading"/>
 
    <div class="wrp-login-page_projct">
        <div class="wrp_project_theme">
            <div class="uk-position-relative">
                <div class="uk-position-top-right">
                    <Button OnClick="@OnInitializedAsync" icon="refresh" class_name="no-btn" title="Refresh" />
                </div>
                <div class="login-header uk-margin-remove">
                    <img src="images/ePOS-Rest.svg" />
                </div>
                <div class="login-form">
                    <div>
                        @if (!is_loading)
                        {

                            @if (model == null)
                            {
                                <p class="warning">@lang["Get Project information fail. Please contact your system administrator"]</p>
                            }
                            else
                            {
                                <div class="uk-text-capitalize uk-text-center uk-panel uk-padding-small" style="font-size: 24px;">@lang["This project is belong to"]</div>
                                <div>
                                    <div class="project-box-info uk-margin-bottom">
                                        <h3 class="project-info-title">Customer Information</h3>
                                        <div class="table_inf">
                                            <table class="uk-table uk-table-small">
                                                <tbody>
                                                    <tr>
                                                        <td class="text-table uk-padding-remove-left">@lang["Company"]</td>
                                                        <td>: @model.customer.company_name</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-table uk-padding-remove-left">@lang["Contact Name"]</td>
                                                        <td>: @model.customer.customer_code - @model.customer.customer_name_en</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-table uk-padding-remove-left">@lang["Phone"]</td>
                                                        <td>: @model.customer.phone_1</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="project-box-info uk-margin-bottom">
                                        <h3 class="project-info-title">System Feature</h3>
                                        <ComConfigProjectFeature project_features="@model.project_system_features" />
                                    </div>
                                    <div class="project-box-info">
                                        <h3 class="project-info-title">@lang["Business Branch"]</h3>
                                        <div>
                                            <ul uk-accordion>
                                                @foreach (var b in model.business_branches)
                                                {
                                                    <li>
                                                        <a class="uk-accordion-title project-box-info-branch" href="#">@b.business_branch_name_en</a>
                                                        <div class="uk-accordion-content">
                                                            <ComConfigBusinessBranchSystemFeature business_branch_system_features="@b.business_branch_system_features" />
                                                            <h3 class="project-info-sub-title">Outlets</h3>
                                                            <Grid ClassName="uk-grid-small uk-child-width-1-2@m uk-grid-match">
                                                                @foreach (var o in b.outlets)
                                                                {
                                                                    <div>
                                                                        <div class="uk-box-shadow-medium uk-padding">
                                                                            <h4 class="uk-margin-small-bottom">@o.outlet_name_en</h4>
                                                                            <div class="uk-padding-small-left">
                                                                                <ul>
                                                                                    @foreach (var s in o.stations)
                                                                                    {
                                                                                        <li>@s.station_name_en <ComSystemFeatureStatus is_deleted="@s.is_deleted" is_full_license="@s.is_full_license" expired_date="@s.expired_date" /></li>
                                                                                    }
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            </Grid>
                                                            @if (b.stock_locations.Count() > 0)
                                                            {
                                                                <h3 class="project-info-sub-title">@lang["Warehouses"]</h3>
                                                                <Grid ClassName="uk-grid-small uk-child-width-1-2@m uk-grid-match">
                                                                    @foreach (var s in b.stock_locations)
                                                                    {
                                                                        <div>
                                                                            <div class="uk-box-shadow-medium uk-padding">
                                                                                <div class="uk-text-center">@s.stock_location_name</div>
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </Grid>
                                                            }
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <Spacing Number="20" />
                                <div>
                                    <div class="box_verify">
                                        <div class="uk-flex uk-flex-middle uk-flex-right">
                                            <div style="margin-right:5px;">
                                                <Icon icon="error_outline" icon_color="#ff002e" />
                                            </div>
                                            <div>
                                                Please verify these information with your system administrator
                                            </div>
                                        </div>
                                    </div>
                                    <div class="uk-text-center">
                                        @if (is_saving)
                                        {
                                            <button class="btn-login" type="button"> <Spinner /> @lang["Confirm"]  </button>
                                        }
                                        else
                                        {
                                            <button class="btn-login" type="submit" @onclick="@ConfirmBackendData">@lang["Confirm"] </button>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="uk-padding uk-text-center">
                                <Spinner ratio="1.8" />
                                <div>Loading...</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
 

@code {
    [CascadingParameter] public GlobalVariableModel gv { get; set; }
    [Parameter] public string project_id { get; set; }
    [Parameter] public string server_id { get; set; }
    eSoftixBackend.ProjectModel model = new eSoftixBackend.ProjectModel();

    bool is_loading,is_saving;


    protected override async Task OnInitializedAsync()
    {

        is_loading = true;
        try
        {
            var resp = await http.eSoftixApiGet($"project({project_id})?$expand=cash_drawers,customer,project_system_features($expand=system_feature),business_branches($expand=business_branch_system_features($expand=system_feature),stock_locations,outlets($expand=stations($filter=is_deleted eq false);$filter=is_deleted eq false);$filter=is_deleted eq false)");
            if (resp.IsSuccess)
            {
                model = JsonSerializer.Deserialize<eSoftixBackend.ProjectModel>(resp.Content.ToString());
            }
        }
        catch {
            model = null;
        }

        is_loading = false;
    }



    async Task ConfirmBackendData()
    {

        is_saving = true;

        //check validation
        //check if project have business branch
        if (!model.business_branches.Any())
        {

            toast.Add(lang["This project does not have business branch."], MudBlazor.Severity.Warning);
            is_saving= false;
            return;
        }
        else {
            foreach(var b in model.business_branches)
            {
                if (!b.outlets.Any()) {
                    toast.Add($"{b.business_branch_name_en} {lang["does not have outlet."]}", MudBlazor.Severity.Warning);
                    is_saving = false;
                    return;
                }
                foreach(var o in b.outlets)
                {
                    if (!o.stations.Any())
                    {
                        toast.Add($"{o.outlet_name_en} {lang["does not have station."]}", MudBlazor.Severity.Warning);
                        is_saving = false;
                        return;
                    }
                }
                //validate stock location
                if(b.business_branch_system_features.Where(x=>(x.system_feature.feature_code =="INV_SIMPLE" && x.status==true) || (x.system_feature.feature_code == "INV_ADVANCE" && x.status == true)).Any())
                {
                    if (b.stock_locations.Count() == 0)
                    {
                         toast.Add($"{b.business_branch_name_en} {lang["does not have stock location."]}", MudBlazor.Severity.Warning);
                        is_saving = false;
                        return;
                    }
                }
            }
        }


        //save server id to project db
        ServerConfigModel project_config = new ServerConfigModel();
        project_config.project_id = model.id.ToString();
        project_config.hardware_server_id = server_id;

        var resp_projct = await http.eSoftixApiPost("Project/SaveServerID", project_config);
        if ( resp_projct.IsSuccess)
        {
            var resp = await http.ApiPost("ConfirmBackendData", model);
            if (resp.IsSuccess)
            {

                toast.Add(lang["Update data successfully."], MudBlazor.Severity.Success);
                nav.NavigateTo("config/done");
            }else
            {
                toast.Add(lang["Confirm data fail. Please try again."], MudBlazor.Severity.Warning);
            }

        }else
        {
            if (resp_projct.status_code == 503)
            {
                toast.Add(lang["Cannot connect to ePOS Server. Please contact your system administrator."], MudBlazor.Severity.Warning);
            }
            else {

                toast.Add(lang["Confirm data fail. Please try again."], MudBlazor.Severity.Warning);
            }

        }


        is_saving = false;
    }

}