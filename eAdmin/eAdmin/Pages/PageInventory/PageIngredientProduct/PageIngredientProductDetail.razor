@page "/ingredient/{id:int}"
@inject IHttpService http
@inject NavigationManager nav
@inject ISnackbar toast
@inject IJSRuntime js
@inject IStringLocalizer<Resource> lang
<Loading is_loading="@(is_loading || is_loading_data)" />
@if (!is_loading)
{

    <Title Value="@lang["Ingredient Detail"]"></Title>
    <PageContainer roles="@gv.GetRole("ingredient_management")">
        <PageHeader>
            <HeaderLeft>
                <PageTitle ShowFilter="false">
                    <HeaderTemplate>
                        @model.product_display_name
                        <ComProductDetail_HeaderStatus model="@model" is_ingredient="false"/>
                    </HeaderTemplate>
                </PageTitle>
            </HeaderLeft>
            <HeaderRight ShowBackButton="true">
                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <Button icon="edit" title="@lang["Edit"]" OnClick="@(()=>nav.NavigateTo($"ingredient/edit/{model.id}"))" is_visible="@(!model.is_deleted)" />
                </MudHidden>
                <ComAttachFileButton RoleAdd="@gv.GetRole("ingredient_add")"
                                     RoleEdit="@gv.GetRole("ingredient_edit")"
                                     RoleDelete="@gv.GetRole("ingredient_delete")"
                                     ApiFilter="@($"product_id eq {id} ")"
                                     File="@(new AttachFilesModel() { product_id =  id })"
                                     IsVisible="@(!model.is_deleted)" @bind-IsOpened="@is_open_attach_file"/>

                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <AddButton url="ingredient/new" roles="@gv.GetRole("ingredient_add")">@lang["New Ingredient"]</AddButton>
                </MudHidden>
                <RefreshButton OnClick="@LoadData" />
                <MoreButton is_loading="@(model.is_loading ||model.is_change_status || model.is_deleting || model.is_restoring)">
                    <MudHidden Breakpoint="Breakpoint.MdAndUp">
                        <MoreButtonItem roles="@gv.GetRole("ingredient_add")" icon="add" url="ingredient/new">@lang["New Ingredient"]</MoreButtonItem>
                        <MoreButtonItem roles="@gv.GetRole("ingredient_edit")" icon="edit" OnClick="@(()=>nav.NavigateTo($"ingredient/edit/{model.id}"))">@lang["Edit"]</MoreButtonItem>
                    </MudHidden>
                        <MoreButtonItem roles="@gv.GetRole("ingredient_add")" icon="file_copy" url="@($"ingredient/clone/{model.id}")">@lang["Clone"]</MoreButtonItem>
                        <MoreButtonItem roles="@gv.GetRole("ingredient_edit")" icon="highlight_off" is_visible="@(!model.is_deleted && model.status)" OnClick="OnChangeStatus">@lang["Inactive"]</MoreButtonItem>
                        <MoreButtonItem roles="@gv.GetRole("ingredient_edit")" icon="check" is_visible="@(!model.is_deleted && !model.status)" OnClick="OnChangeStatus">@lang["Active"]</MoreButtonItem>
                        <MoreButtonItem roles="@gv.GetRole("ingredient_delete")" icon="delete" is_visible="@(!model.is_deleted)" OnClick="@OnDelete">@lang["Delete"]</MoreButtonItem>
                        <MoreButtonItem roles="@gv.GetRole("ingredient_edit")" icon="refresh" is_visible="@(model.is_deleted)" OnClick="@OnRestore">@lang["Restore"]</MoreButtonItem>
                        <MudHidden Breakpoint="Breakpoint.MdAndUp">
                            <MudDivider />
                            <ComAttachFileButton RoleAdd="@gv.GetRole("ingredient_add")"
                                                 RoleEdit="@gv.GetRole("ingredient_edit")"
                                                 RoleDelete="@gv.GetRole("ingredient_delete")"
                                                 ApiFilter="@($"product_id eq {id} ")"
                                                 File="@(new AttachFilesModel() { product_id =  id })"
                                                 IsVisible="@(!model.is_deleted)"
                                                 IsIconButton="false"
                                                 OnOpenAttachFile="@(()=>is_open_attach_file = !is_open_attach_file)" />
                        </MudHidden>
                </MoreButton>

            </HeaderRight>
        </PageHeader>
        <PageBody>
            <Tab>
                <TabHeader>
                    <TabHeaderItem>@lang["General Information"]</TabHeaderItem>
                    <TabHeaderItem OnClick="@(()=>show_association_products = true)">@lang["Associate Products & Modifiers"]</TabHeaderItem>
                    <TabHeaderItem OnClick="@(()=>show_inventory_transation = true)">@lang["Inventory Transaction"]</TabHeaderItem>
                    <TabHeaderItem OnClick="@(()=>show_comment_tab=true)">@lang["Comment and History"]</TabHeaderItem>
                </TabHeader>
                <TabBody>
                    <TabItem>
                        <ComIngredientProductDetail_Formation model="@model"/>
                    </TabItem>
                    <TabItem>
                        @if (show_association_products)
                        {
                            <ComIngredientProductDetail_AssociationProductsAndModifiers ingredient_id="@model.id"/>
                        }
                        
                    </TabItem>
                    <TabItem>
                        @if (show_inventory_transation)
                        {
                            <ComProductDetail_InventoryTransactionHistory product_id="@model.id" />
                        }
                    </TabItem>
                    <TabItem>
                        @if (show_comment_tab)
                        {
  <ComHistory RoleAdd="@gv.GetRole("ingredient_add")"
                                            RoleDelete="@gv.GetRole("ingredient_delete")"
                                            RoleEdit="@gv.GetRole("ingredient_add")"
                                            ApiFilter="@($"product_id eq {id}")"
                                            history="@(new HistoryModel() { product_id = id})" />
                               
                            
                        }
                    </TabItem>

                </TabBody>
            </Tab>
             
        </PageBody>
    </PageContainer>
}

@code{
    [Parameter] public int id { get; set; }
    [CascadingParameter] public GlobalVariableModel gv { get; set; }
    public ProductModel model { get; set; }
    bool is_open_attach_file;
    bool is_loading, is_loading_data,show_comment_tab,show_association_products,show_inventory_transation;

    public string api_url { get {
            string url = $"Product({id})";
            url = url + "?$expand=product_category($select=product_category_en),unit,vendor($select=id,vendor_code, vendor_name,photo)";
            return url;
        }
    }
    protected override async Task OnInitializedAsync()
    {

        is_loading = true;
        await LoadData();
        is_loading = false;
    }


    async Task LoadData()
    {
        is_loading = true;
        var resp =await http.ApiGet(api_url);
        if (resp.IsSuccess)
        {
            model = JsonSerializer.Deserialize<ProductModel>(resp.Content.ToString());
        }
        is_loading = false;

    }

    async Task OnDelete()
    {


        model.is_deleting = true;
        if(await js.Confirm(lang["Delete Record"], lang["Are you sure you want to delete this record?"], SweetAlertMessageType.question))
        {
            var resp = await http.ApiPost("Product/delete/" + id);
            if (resp.IsSuccess)
            {
                toast.Add(lang["Delete record successfully"], MudBlazor.Severity.Success);
                model.is_deleted = true;

            }
        }


        model.is_deleting = false;
    }
    async Task OnRestore()
    {

        model.is_restoring = true;
        if (await js.Confirm(lang["Restore Record"], lang["Are you sure you want to retore this record?"], SweetAlertMessageType.question))
        {
            var resp = await http.ApiPost("Product/delete/" + id);
            if (resp.IsSuccess)
            {
                toast.Add(lang["Restore record successfully"], MudBlazor.Severity.Success);
                model.is_deleted = false;

            }
        }
        model.is_restoring = false;
    }
    async Task OnChangeStatus()
    {

        model.is_change_status = true;

        var resp = await http.ApiPost("Product/ChangeStatus/" + id);
        if (resp.IsSuccess)
        {
            toast.Add(lang["Change status successfully"], MudBlazor.Severity.Success);
            model.status = !model.status;

        }
        model.is_change_status = false;
    }


}

 