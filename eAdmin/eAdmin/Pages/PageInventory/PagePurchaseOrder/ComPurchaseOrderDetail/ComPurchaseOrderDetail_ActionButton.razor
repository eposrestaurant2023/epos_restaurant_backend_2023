@inject IHttpService http
@inject  IJSRuntime js 
@inject IMatToaster toast;
@inject NavigationManager nav;

<Loading is_loading="@is_loading" />
<ButtonGroup>
    <Button title="Print" icon="print" is_visible="@(po.is_deleted == false && po.status == true)" OnClick="Print_Click" />
    <Button roles="@gv.GetRole("purchase_order_edit")" OnClick="@(()=>nav.NavigateTo($"purchaseorder/edit/{po.id}"))" icon="edit" title="Edit" is_visible="@(po.can_edit && !po.is_fulfilled)" />
    <Button roles="@gv.GetRole("purchase_order_add_payment")" icon="payment" title="Add Payment" is_visible="@(po.is_deleted == false && po.status == true && po.balance > 0)" OnClick="@OnAddPayment">
        (@po.purchase_order_payments.Where(r=>!r.is_deleted).Count())
    </Button>
</ButtonGroup>

<ComAttachFileButton RoleAdd="@gv.GetRole("purchase_order_add")"
                     RoleEdit="@gv.GetRole("purchase_order_edit")"
                     RoleDelete="@gv.GetRole("purchase_order_delete")"
                     ApiFilter="@($"purchase_order_id eq {po.id} ")"
                     File="@file"
                     IsVisible="@(!po.is_deleted)" />

<AddButton roles="@gv.GetRole("purchase_order_add")" url="purchaseorder/new">New Purchase Order</AddButton>
<MoreButton is_loading="@po.is_loading">
    <MoreButtonItem roles="@gv.GetRole("purchase_order_edit")" icon="cached" is_visible="@po.is_fulfilled" OnClick="@CancelFulfilled_Click">Cancel Fulfilled</MoreButtonItem>
    <MoreButtonItem roles="@gv.GetRole("purchase_order_delete")" icon="delete" is_visible="@po.can_delete" OnClick="@DeleteInvoice_Click">Delete Invoice</MoreButtonItem>
    @*<MoreButtonItem roles="@gv.GetRole("sale_restore")" icon="refresh" is_visible="@(sale.can_restore)" OnClick="@RestoreInvoice_Click">Restore Invoice</MoreButtonItem>*@
</MoreButton>

@if (is_open_print)
{
    <ComPreviewReport parent_id="117" report_id="118" id="@po.id" IsOpened="is_open_print" OnClose="@(()=>is_open_print=false)" />
}
 

@code {
    [Parameter] public PurchaseOrderModel po { get; set; }
    [Parameter] public EventCallback<PurchaseOrderModel> poChanged { get; set; }
    [Parameter] public EventCallback<MouseEventArgs> OnAddPayment { get; set; }

    [CascadingParameter] public GlobalVariableModel gv { get; set; }

    AttachFilesModel file = new AttachFilesModel();
    bool is_loading;


    protected override void OnInitialized()
    {

        if (po.vendor_id > 0) file.vendor_id = po.vendor_id;
        file.purchase_order_id = po.id;
    }


    bool is_open_print = false;

    void Print_Click()
    {

        is_open_print = true;
    }

    async Task DeleteInvoice_Click()
    {
        is_loading = true;
        if (await js.Confirm("Delete Sale Invoice", "Are you sure you want to delete this sale invoice?", SweetAlertMessageType.question))
        {
            var resp = await http.ApiPost($"purchaseorder/delete/{po.id}");
            if (resp.IsSuccess)
            {
                po.is_deleted = !po.is_deleted;
                await poChanged.InvokeAsync(po);
                toast.Add("Delete PO invoice successfully.", MatToastType.Success);
            }
            else
            {
                toast.Add(resp.Content, MatToastType.Warning);
            }
        }

        is_loading = false;

    }
    async Task RestoreInvoice_Click()
    {


        is_loading = true;
        if (await js.Confirm("Restore Sale Invoice", "Are you sure you want to restore this sale invoice?", SweetAlertMessageType.question))
        {
            var resp = await http.ApiPost($"purchaseorder/delete/{po.id}");
            if (resp.IsSuccess)
            {

                po.is_deleted = !po.is_deleted;
                await poChanged.InvokeAsync(po);
                toast.Add("Restore PO invoice successfully.", MatToastType.Success);
            }
            else
            {
                toast.Add(resp.Content, MatToastType.Warning);
            }
        }

        is_loading = false;
    }

    async Task CancelFulfilled_Click()
    {
        is_loading = true;
        if (await js.Confirm("Cancel Fulfilled", "Are you sure you want to cancel fulfilled?"))
        {
            var resp = await http.ApiPost("PurchaseOrder/CancelFulfilled/" + po.id);
            if (resp.IsSuccess)
            {
                po.is_fulfilled = !po.is_fulfilled;
                await poChanged.InvokeAsync(po);
                toast.Add("Mark as fulfilled successfully", MatToastType.Success);
            }
        }

        is_loading = false;
    }
}
