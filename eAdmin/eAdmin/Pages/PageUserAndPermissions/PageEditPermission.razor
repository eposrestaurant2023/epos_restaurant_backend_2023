@page "/role/edit/permission/{role_id:int}"
@inherits PageCore
<Loading is_loading="@is_loading" />
@if (!is_loading)
{
     <Microsoft.AspNetCore.Components.Web.Extensions.Head.Title Value="@lang["Set Permission"]"></Microsoft.AspNetCore.Components.Web.Extensions.Head.Title>
    <PageContainer roles="@gv.GetRole($"{(role_id > 0 ? "role_edit" : "role_add")}")">
        <PageHeader>
            <HeaderLeft>
                <PageTitle ShowFilter="false">
                    <HeaderTemplate>
                        <span>@lang["Set Permission"] - @role.role_name</span>
                    </HeaderTemplate>
                </PageTitle>
            </HeaderLeft>
            <HeaderRight ShowBackButton="true">
               
            </HeaderRight>
        </PageHeader>
        <EditForm Model="@role" OnValidSubmit="@SaveRole_Click">
            <DataAnnotationsValidator />
            <PageBody>
                <Spacing Number="20" />
                <MudTabs PanelClass="pa-6">
                    <MudTabPanel Text="@lang["Front End"]">
                        <UIGridCenter>
                            <UIContainerBox Title="Front End">
                                <MudTreeView CanActivate="true" @bind-SelectedValues="@SelectedOptionFrontend" Items="@(new HashSet<PermissionModel>(permissions.Where(r=>r.is_front_end == true)))" T="PermissionModel" CanSelect="true" Context="d">
                                    <ItemTemplate>
                                        <MudTreeViewItem @bind-Selected="@d.is_selected" Items="@(new HashSet<PermissionModel>(d.ChildItem.Where(r=>r.is_front_end == true)))" Value="@d" Text="@d.note">

                                        </MudTreeViewItem>
                                    </ItemTemplate>
                                </MudTreeView>
                            </UIContainerBox>
                        </UIGridCenter>
                    </MudTabPanel>
                    <MudTabPanel OnClick="@showisbackend" Text="@lang["Back End"]">
                        <UIGridCenter>
                            <UIContainerBox Title="Back End">
                                <MudTreeView CanActivate="true" @bind-SelectedValues="@SelectedOptionBackend" Items="@(new HashSet<PermissionModel>(permissions.Where(r=>r.is_front_end  == false && r.is_report==false && r.parent_id!=44)))" T="PermissionModel" CanSelect="true" Context="d">
                                    <ItemTemplate>
                                        <MudTreeViewItem @bind-Selected="@d.is_selected" Items="@(new HashSet<PermissionModel>(d.ChildItem.Where(r=>r.is_front_end  == false && r.is_report == false)))" Value="@d" Text="@d.note">

                                        </MudTreeViewItem>
                                    </ItemTemplate>
                                </MudTreeView>
                            </UIContainerBox>
                        </UIGridCenter>
                    </MudTabPanel>
                    <MudTabPanel OnClick="@showisreport" Text="@lang["Report"]">
                        <UIGridCenter>

                            <UIContainerBox Title="Report">
                                <MudTreeView T="PermissionModel" CanActivate="true" @bind-SelectedValues="@SelectedOptionReport" Items="@(new  HashSet<PermissionModel>(permissions.Where(r=>r.is_report  == true && r.id == 44)))" CanSelect="true" Context="d">
                                    <ItemTemplate>
                                        <MudTreeViewItem @bind-Selected="@d.is_selected" Items="@(new HashSet<PermissionModel>(d.ChildItem.Where(r=>r.is_report == true)))" Value="@d" Text="@d.note">

                                        </MudTreeViewItem>
                                    </ItemTemplate>
                                </MudTreeView>
                            </UIContainerBox>
                        </UIGridCenter>
                    </MudTabPanel>
                </MudTabs>
            </PageBody>
            <PageFooter>
                <FooterCenter>
                    <ComSavingFormButton is_loading="@is_saving" />
                </FooterCenter>
            </PageFooter>
        </EditForm>
    </PageContainer>
}


@code {
    [Parameter] public int role_id { get; set; }

    public HashSet<PermissionModel> SelectedOptionFrontend { get; set; } = new HashSet<PermissionModel>();
    public HashSet<PermissionModel> SelectedOptionBackend { get; set; } = new HashSet<PermissionModel>();
    public HashSet<PermissionModel> SelectedOptionReport { get; set; } = new HashSet<PermissionModel>();
    List<PermissionModel> permissions{ get; set; } = new List<PermissionModel>();
    RoleModel role = new RoleModel();

    protected override async Task OnInitializedAsync()
    {
        is_loading = true;
        await LoadPermission();
        await loadRole();
        is_loading = false;
    }

    async Task loadRole()
    {
        var res = await http.ApiGet($"role({role_id})?$expand=permission_option_roles($select=role_id,permission_option_id)");
        if (res.IsSuccess)
        {
            role = JsonSerializer.Deserialize<RoleModel>(res.Content.ToString());
        }
    }

    protected async Task SaveRole_Click()
    {
        is_saving = true;

        var post = await http.ApiPost($"Role/SavePermission", new OptionModel()
        {
            role_id = role_id,
            options = string.Join(",", SelectedOptionFrontend.Select(r => r.id).ToArray()) + "," +
                    string.Join(",", SelectedOptionBackend.Select(r => r.id).ToArray()) + "," +
                      string.Join(",", SelectedOptionReport.Select(r => r.id).ToArray())
        });
        if (post.IsSuccess)
        {
            toast.Add(lang["Save successfully"], MudBlazor.Severity.Success);
          
        }
        else
        {
            toast.Add(lang["Save data fail."], MudBlazor.Severity.Warning);
        }

        is_saving = false;
    }


    public async Task LoadPermission()
    {
        var resp = await http.ApiPost("GetData", new FilterModel()
        {
            procedure_parameter = $"{role_id}",
            procedure_name = "sp_get_permission_option_by_role_id_json"
        });
        if (resp.IsSuccess)
        {
            permissions = JsonSerializer.Deserialize<List<PermissionModel>>(resp.Content.ToString());
        }
    }

    public void showisbackend()
    {
         
         
         
    }

    public void showisreport()
    {
         
          
    }

    public class PermissionModel
    {
        public PermissionModel()
        {
            ChildItem = new HashSet<PermissionModel>();
        }
        public int id { get; set; }
        public int? parent_id { get; set; }
        public string note { get; set; }
        public bool is_selected { get; set; } = false;
        public bool is_front_end { get; set; }
        public bool is_report { get; set; }
        public HashSet<PermissionModel> ChildItem { get; set; }

    }

}
