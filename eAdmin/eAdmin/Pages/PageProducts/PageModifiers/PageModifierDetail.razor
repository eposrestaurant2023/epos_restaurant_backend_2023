@page "/modifier/{id:int}"
@inherits PageCore
@inject IStringLocalizer<Resource> lang

<Loading is_loading="@(is_loading || is_loading_data)" />

@if (!is_loading && !is_error)
{
    <Title Value="Modifier Group Detail"></Title>
    <PageContainer roles="@gv.GetRole("modifier_view")">
        <PageHeader>
            <HeaderLeft>
                <PageTitle ShowFilter="false">
                    <HeaderTemplate>
                        @modifier_group.modifier_group_name_en
                        <LabelDeleted is_visible="@modifier_group.is_deleted" />
                        <LabelActive is_visible="@(!modifier_group.is_deleted && modifier_group.status)" is_loading="@modifier_group.is_change_status" />
                        <LabelInActive is_visible="@(!modifier_group.is_deleted && !modifier_group.status)" is_loading="@modifier_group.is_change_status" />
                    </HeaderTemplate>
                </PageTitle>
            </HeaderLeft>
            <HeaderRight ShowBackButton="true">
                <Button roles="@gv.GetRole("modifier_edit")" icon="edit" title="Edit" OnClick="@(()=>nav.NavigateTo($"modifier/edit/{modifier_group.id}"))" is_visible="@(!modifier_group.is_deleted)" />
                <ComAttachFileButton RoleAdd="@gv.GetRole("modifier_add")"
                                     RoleEdit="@gv.GetRole("modifier_edit")"
                                     RoleDelete="@gv.GetRole("modifier_delete")"
                                     ApiFilter="@($"modifier_id eq {id} ")"
                                     File="@(new AttachFilesModel() { modifier_group_id =  id })"
                                     IsVisible="@(!modifier_group.is_deleted)" />
                <AddButton url="modifiergroup/new" roles="@gv.GetRole("modifier_add")">New Modifier</AddButton>
                <MoreButton is_loading="@(modifier_group.is_loading ||modifier_group.is_change_status || modifier_group.is_deleting || modifier_group.is_restoring)">
                    <MoreButtonItem roles="@gv.GetRole("modifier_add")" icon="file_copy" url="@($"modifier/clone/{modifier_group.id}")">Clone</MoreButtonItem>
                    <MoreButtonItem roles="@gv.GetRole("modifier_edit")" icon="highlight_off" is_visible="@(!modifier_group.is_deleted && modifier_group.status)" OnClick="@(()=>OnChangeStatus(modifier_group))">Inactive</MoreButtonItem>
                    <MoreButtonItem roles="@gv.GetRole("modifier_edit")" icon="check" is_visible="@(!modifier_group.is_deleted && !modifier_group.status)" OnClick="@(()=>OnChangeStatus(modifier_group))">Active</MoreButtonItem>
                    <MoreButtonItem roles="@gv.GetRole("modifier_delete")" icon="delete" is_visible="@(!modifier_group.is_deleted)" OnClick="@(()=>OnDelete(modifier_group))">Delete</MoreButtonItem>
                    <MoreButtonItem roles="@gv.GetRole("modifier_restore")" icon="refresh" is_visible="@(modifier_group.is_deleted)" OnClick="@(()=>OnRestore(modifier_group))">Restore</MoreButtonItem>
                </MoreButton>
                <RefreshButton OnClick="@LoadData" />
            </HeaderRight>
        </PageHeader>
        <PageBody>
            <Tab>
                <TabHeader>
                    <TabHeaderItem>Overview</TabHeaderItem>
                    <TabHeaderItem OnClick="@(()=>show_comment_tab=true)">Comment</TabHeaderItem>
                </TabHeader>
                <TabBody>
                    <TabItem>
                        <UIGridCenter>
                            <UIContainerBox Title="Information">
                                <table>
                                    <tr>
                                        <th>Name En</th>
                                        <td>@modifier_group.modifier_group_name_en</td>
                                    </tr>
                                    @if (!string.IsNullOrEmpty(modifier_group.modifier_group_name_kh))
                                    {
                                        <tr>
                                            <th>Name Kh</th>
                                            <td>@modifier_group.modifier_group_name_kh</td>
                                        </tr>
                                    }
                                </table>
                            </UIContainerBox>
                        </UIGridCenter>
                        <UIGridCenter>
                            <ComModifierGroupDetail_Modifier modifier_group="@modifier_group" />
                        </UIGridCenter>
                    </TabItem>
                    @*============comment===========*@
                    <TabItem>
                        @if (show_comment_tab)
                        {
                            <UIGridCenter>
                                <UIContainerBox Title="Comment and History">
                                    <ComHistory RoleAdd="@gv.GetRole("modifier_add")"
                                                RoleDelete="@gv.GetRole("modifier_delete")"
                                                RoleEdit="@gv.GetRole("modifier_edit")"
                                                ApiFilter="@($"modifier_id eq {id}")"
                                                history="@(new HistoryModel() { modifier_group_id = id})" />
                                </UIContainerBox>
                            </UIGridCenter>
                        }
                    </TabItem>
                </TabBody>
            </Tab>

        </PageBody>
    </PageContainer>
}
else
{
    <Spinner />
}
@if (is_error)
{
    <Error title="Product">@error_text</Error>
}

@code{
    [Parameter] public int id { get; set; }
    string controller_api = "Modifier";
    ModifierGroupModel modifier_group = new ModifierGroupModel();
    List<ProductGroupModel> product_groups = new List<ProductGroupModel>();

    bool is_save_and_new = false;
    bool show_comment_tab = false;
    protected override async Task OnInitializedAsync()
    {
        is_loading = true;
        await LoadData();
        await LoadProductGroup();
    }

    async Task LoadData()
    {
        is_loading = true;

        var resp = await http.ApiGet($"{controller_api}({id})");
        if (resp.IsSuccess)
        {
            modifier_group = JsonSerializer.Deserialize<ModifierGroupModel>(resp.Content.ToString());
        }
        is_loading = false;
    }

    async Task LoadProductGroup()
    {
        var resp = await http.ApiGetOData("ProductGroup?$expand=product_categories($expand=modifier_group_product_categories($filter=is_deleted eq false);$filter=is_deleted eq false and status eq true)&$filter=is_deleted eq false and status eq true and id gt 1 ");
        if (resp.IsSuccess)
        {
            product_groups = JsonSerializer.Deserialize<List<ProductGroupModel>>(resp.Content.ToString());
        }
    }

    async Task OnChangeStatus(ModifierGroupModel u)
    {
        u.is_loading = true;
        var resp = await http.ApiPost(controller_api + "/status/" + u.id);
        if (resp.IsSuccess)
        {
            toast.Add("Change status successfully", MatToastType.Success);
            await LoadData();
        }
        else
        {
            toast.Add(resp.Content.ToString(), MatToastType.Danger);
        }
        u.is_loading = false;
    }

    async Task OnRestore(ModifierGroupModel p)
    {
        p.is_loading = true;
        if (await js.Confirm("Restore modifier", "Are you sure you want to restore " + p.modifier_group_name_en + "?", SweetAlertMessageType.question))
        {
            var resp = await http.ApiPost(controller_api + "/delete/" + p.id);
            if (resp.IsSuccess)
            {
                await LoadData();
                toast.Add("Restore modifier successfully", MatToastType.Success);
            }
            else
            {
                toast.Add(resp.Content.ToString(), MatToastType.Warning);
            }
        }
        p.is_loading = false;
    }

    async Task OnDelete(ModifierGroupModel p)
    {
        p.is_loading = true;
        if (await js.Confirm("Delete modifier", "Are you sure you want to delete " + p.modifier_group_name_en + "?", SweetAlertMessageType.question))
        {
            var resp = await http.ApiPost(controller_api + "/delete/" + p.id);

            if (resp.IsSuccess)
            {
                await LoadData();
            }
            toast.Add("Delete modifier successfully", MatToastType.Success);
        }
        p.is_loading = false;
    }
}
