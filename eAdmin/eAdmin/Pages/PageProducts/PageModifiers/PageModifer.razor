@page "/modifier";
@inherits PageCore

@using eModels;

<Loading is_loading="@(is_loading || is_loading_data)" />
@{
    RenderFragment HeaderTemplate(string field_name, string display_name, string ClassName = "") =>
    @<Th OnClick="@(async () => await OrderBy(field_name))" OrderBy="@(state.pager.order_by == field_name)" OrderByType="@state.pager.order_by_type" ClassName="@($"cp {ClassName}")"> @display_name</Th>;
}
@if (!is_loading)
{
    <Microsoft.AspNetCore.Components.Web.Extensions.Head.Title Value="@lang["Modifier"]"></Microsoft.AspNetCore.Components.Web.Extensions.Head.Title>
    <PageContainer roles="@gv.GetRole("modifier_management")">
        <PageHeader>
            <HeaderLeft>
                <PageTitle>
                    <HeaderTemplate>
                        @lang[state.page_title]
                    </HeaderTemplate>
                    <FilterTemplate>
                        <PageFilter title="@lang["Status"]">
                            <ModuleView module_views="@gv.GetModuleView("page_modifier")" OnClick="@ViewClick" />
                        </PageFilter>
                    </FilterTemplate>
                </PageTitle>
            </HeaderLeft>
            <HeaderRight>
                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <AddButton roles="@gv.GetRole("modifier_add")" OnClick="@(()=> nav.NavigateTo("modifier/new"))">@lang["New"]</AddButton>

                </MudHidden>
                <MudHidden Breakpoint="Breakpoint.MdAndUp">
                    <AddButton roles="@gv.GetRole("modifier_add")" OnClick="@(()=> nav.NavigateTo("modifier/new"))"></AddButton>

                </MudHidden>
                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <ComSearch place_holder="@GetFilterValue2(state.filters, "keyword", "")" KeywordChanged="@OnSearch" show_advance_filter="false" />
                </MudHidden>
                <RefreshButton OnClick="@OnInitializedAsync" />
            </HeaderRight>
        </PageHeader>
        <PageBody>
            <MudHidden Breakpoint="Breakpoint.MdAndUp">
                <ComSearch is_fullwidth="true" place_holder="@GetFilterValue2(state.filters, "keyword", "")" KeywordChanged="@OnSearch" show_advance_filter="false" />
                <Spacing Number="4"/>
            </MudHidden>
            <div class="cus_overflow-auto">
                <Table ShowPager="true"
                       TotalItem="TotalItem"
                       OnPageChange="@OnPageChange"
                       OnPagerChange="@OnPagerChange"
                       PerPage="@state.pager.per_page"
                       CurrentPage="@state.pager.current_page"
                       Items="@modifiers"
                       ShowCounter="true">
                    <TableHeader>
                        @HeaderTemplate("modifier_name", lang["Name"], "col-auto")
                        <ThCenter>@lang["Status"]</ThCenter>
                        <th></th>
                    </TableHeader>
                    <RowTemplate Context="m">
                        <td>
                            <ComAuthorize roles="@gv.GetRole("modifier_view")" OnClick="@(()=>nav.NavigateTo($"modifier/{m.id}"))">
                                @m.modifier_name
                            </ComAuthorize>
                        </td>
                        <TdCenter>
                            @if (!m.is_loading)
                                {
                                <LabelActive is_visible="@(m.status && !m.is_deleted)" OnClick="@(() => OnChangeStatus(m))" roles="@gv.GetRole("modifier_edit")" is_loading="@m.is_change_status" />
                                <LabelInActive is_visible="@(!m.status && !m.is_deleted)" OnClick="@(() => OnChangeStatus(m))" roles="@gv.GetRole("modifier_edit")" is_loading="@m.is_change_status" />
                                <LabelDeleted is_visible="@(m.is_deleted)" />
                                }
                                else
                                {
                                <Spinner />
                                }
                        </TdCenter>
                        <TdCenter>
                            <ComTableActions is_loading="@(m.is_loading)">
                                <TableActionItem roles="@gv.GetRole("modifier_view")" icon="visibility" url="@($"modifier/{m.id}")">@lang["View"]</TableActionItem>
                                <TableActionItem roles="@gv.GetRole("modifier_edit")" icon="edit" @onclick="(() => Edit_Click(m))" is_visible="@(!m.is_deleted)">@lang["Edit"]</TableActionItem>
                                <TableActionItem roles="@gv.GetRole("modifier_add")" icon="file_copy" OnClick="@(()=>Clone_Click(m.id))">@lang["Clone"]</TableActionItem>
                                <TableActionItem icon="check" roles="@gv.GetRole("modifier_edit")" @onclick="(() => OnChangeStatus(m))" is_visible="@(!m.status && !m.is_deleted)">@lang["Active"]</TableActionItem>
                                <TableActionItem icon="highlight_off" roles="@gv.GetRole("modifier_edit")" @onclick="(() => OnChangeStatus(m))" is_visible="@(m.status && !m.is_deleted)">@lang["Inactive"]</TableActionItem>
                                <TableActionItem icon="delete" roles="@gv.GetRole("modifier_delete")" @onclick="(() => OnDelete(m))" is_visible="@(!m.is_deleted)">@lang["Deleted"]</TableActionItem>
                                <TableActionItem icon="refresh" roles="@gv.GetRole("modifier_restore")" @onclick="(() => OnRestore(m))" is_visible="@(m.is_deleted)">@lang["Restore"]</TableActionItem>
                            </ComTableActions>
                        </TdCenter>
                    </RowTemplate>
                </Table>
            </div>
        </PageBody>
    </PageContainer>
}

@code {
    [Parameter] public string status { get; set; }
    List<ModifierModel> modifiers = new List<ModifierModel>();
    int TotalItem;

    string controller_api = "Modifier";
    public string StateKey
    {
        get
        {

            return "55sNaBpzJlLzh2114785239lwfBSCTTx" + gv.current_login_user.id; //Storage and Session Key  
        }
    }
    public string ControllerApi
    {
        get
        {
            if (state.pager.order_by == "" || state.pager.order_by == "id")
            {
                state.pager.order_by = "id";
                state.pager.order_by_type = "desc";
            }
            string url = $"{controller_api}?&keyword={GetFilterValue2(state.filters, "keyword", "").ToString()}&$count=true&$top={state.pager.per_page}&$skip={state.pager.per_page * (state.pager.current_page - 1)}&$orderby={state.pager.order_by} {state.pager.order_by_type}";
            return url + GetFilter(state.filters);

        }
    }

    protected override async Task OnInitializedAsync()
    {
        is_loading = true;

        state = await GetState(StateKey);
        if (state.page_title == "")
        {
            state.page_title = $"All modifier";
            var default_view = gv.GetDefaultModuleView("page_modifier");
            if (default_view != null)
            {
                state.filters.Add(new FilterModel() { key = "is_deleted", value1 = "false" });
                state.page_title = string.Format(default_view.title);
                state.filters = default_view.filters;
                if (!string.IsNullOrEmpty(default_view.default_order_by))
                {
                    state.pager.order_by = default_view.default_order_by;
                    state.pager.order_by_type = default_view.default_order_by_type;
                }
            }
        }

        await LoadData(state.api_url);
        is_loading = false;
    }

    async Task LoadData(string api_url = "")
    {
        is_loading = true;
        if (string.IsNullOrEmpty(api_url))
        {
            api_url = $"{ControllerApi}";
            state.api_url = api_url;
            await SetState(StateKey, state);
        }
        var resp = await http.ApiGetOData(api_url);
        if (resp.IsSuccess)
        {
            modifiers = JsonSerializer.Deserialize<List<ModifierModel>>(resp.Content.ToString());
            TotalItem = resp.Count;
        }
        is_loading = false;
    }

    void Edit_Click(ModifierModel _user)
    {
        nav.NavigateTo($"modifier/edit/{_user.id}");
    }

    void Clone_Click(Guid id)
    {
        nav.NavigateTo($"modifier/clone/{id}");
    }

    async Task OnChangeStatus(ModifierModel u)
    {
        u.is_loading = true;
        var resp = await http.ApiPost(controller_api + "/status/" + u.id);
        if (resp.IsSuccess)
        {
            toast.Add(lang["Change status successfully"], MudBlazor.Severity.Success);
            if (modifiers.Count() == 1 && state.pager.current_page > 1)
            {
                state.pager.current_page = state.pager.current_page - 1;
            }
            await LoadData();
        }
        else
        {
            toast.Add(resp.Content.ToString(), MudBlazor.Severity.Error);

        }
        u.is_loading = false;
    }

    async Task OnRestore(ModifierModel p)
    {
        p.is_loading = true;
        if (await js.Confirm(lang["Restore Record"], lang["Are you sure you want to restore this record?"], SweetAlertMessageType.question))
        {
            var resp = await http.ApiPost(controller_api + "/delete/" + p.id);
            if (resp.IsSuccess)
            {
                if (modifiers.Count() == 1 && state.pager.current_page > 1)
                {
                    state.pager.current_page = state.pager.current_page - 1;
                }
                await LoadData();
                toast.Add(lang["Restore record successfully"], MudBlazor.Severity.Success);
            }
            else
            {
                toast.Add(resp.Content.ToString(), MudBlazor.Severity.Warning);
            }
        }
        p.is_loading = false;
    }

    async Task OnDelete(ModifierModel p)
    {
        p.is_loading = true;
        if (await js.Confirm(lang["Delete Record"], lang["Are you sure you want to delete this record?"], SweetAlertMessageType.question))
        {
            var resp = await http.ApiPost(controller_api + $"/delete/{p.id}");

            if (resp.IsSuccess)
            {
                if (modifiers.Count() == 1 && state.pager.current_page > 0)
                {
                    state.pager.current_page = state.pager.current_page - 1;
                }
                toast.Add(lang["Delete record successfully"], MudBlazor.Severity.Success);
                await LoadData();
            }
        }
        p.is_loading = false;
    }

    async Task OnPagerChange(int total)
    {
        is_loading = true;
        state.pager.current_page = 1;
        state.pager.per_page = total;
        await LoadData();
        is_loading = false;
    }

    async Task OnPageChange(int current_page)
    {
        is_loading = true;
        state.pager.current_page = current_page;
        await LoadData();
        is_loading = false;
    }

    async Task ViewClick(ModuleViewModel m)
    {
        state.filters.Clear();
        state.filters = m.filters;
        state.page_title = m.title;
        state.pager.current_page = 1;
        await LoadData();

    }

    async Task OnSearch(string keyword)
    {
        is_loading = true;
        state.pager = new PagerModel();
        SetFilterValue2(state.filters, "keyword", keyword, true);
        await LoadData();
        is_loading = false;
    }

    async Task OrderBy(string col_name = "")
    {
        state.pager.order_by = col_name;
        state.pager.order_by_type = (state.pager.order_by_type == "asc" ? "desc" : "asc");
        await LoadData();
    }

    async Task Save_Click(ModifierModel modifier)
    {
        modifier.is_loading = true;
        var res = await http.ApiPost($"{controller_api}/save", modifier);
        if (res.IsSuccess)
        {
            var u = JsonSerializer.Deserialize<ModifierModel>(res.Content.ToString());
            toast.Add(lang["Save successfully"], MudBlazor.Severity.Success);
            await LoadData();
             
        }
        else
        {
            toast.Add(res.Content.ToString(), MudBlazor.Severity.Warning);
        }
        modifier.is_loading = false;
    }
}

