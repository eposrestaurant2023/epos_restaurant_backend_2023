@inject IHttpService http
@inject IMatToaster toast
<UIGridCenter>
@foreach(var pp in model.product_portions){
    <UIContainerBox Title="@pp.portion_name" 
        is_show_add_button="@(!model.product_ingredients.Where(r=>r.product_portion_id == pp.id).Any())"
        is_show_edit_button="@model.product_ingredients.Where(r=>r.product_portion_id == pp.id).Any()"
        OnAddClick="@(()=>OnShowModal(model.product_ingredients.Where(r=>r.product_portion_id == pp.id).ToList(), pp.id))"
        OnEditClick="@(()=>OnShowModal(model.product_ingredients.Where(r=>r.product_portion_id == pp.id).ToList(), pp.id))">

        <table class="uk-table  view_table set-verticle-middle uk-table-small uk-table-striped uk-table-hover">
            <tr>
                <ThAuto>Ingredient Name</ThAuto>
                <ThCenter>Quantity</ThCenter>
                <ThCenter>Unit</ThCenter>
                <ThRight>Cost</ThRight>
                <ThRight>Total Cost</ThRight>
            </tr>

            @if(model.product_ingredients.Where(r=>r.product_portion_id == pp.id).Any()){
                foreach(var pi in model.product_ingredients.Where(r=>r.product_portion_id == pp.id).ToList())
                {
                    <tr>
                        <td>
                            @pi.product_ingredient?.product_display_name
                        </td>
                        <TdCenter>
                            @pi.quantity
                        </TdCenter>
                        <TdCenter>@pi.unit</TdCenter>
                        <TdRight>@pi.cost.ToString(gv.currency_format)</TdRight>
                        <TdRight>@pi.total_cost.ToString(gv.currency_format)</TdRight>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="5">
                    <ComEmptyTemplate padding_top_bottom="25px"/>
                    </td>
                </tr>
            }
        </table>
    </UIContainerBox>
    <Spacing Number="25"/>
    }
</UIGridCenter>
<Com is_visible="@(model != null && product_portion_id > 0)">
    <ComProductDetail_AddIngredientProduct models="@product_ingredients" @bind-is_open="@show_modal" Save_Click="OnSave" selected_product_portion_id="@product_portion_id"/>
</Com>
@code {
    [CascadingParameter] public GlobalVariableModel gv { get; set; }
    [Parameter] public int product_id { get; set; } 
    ProductModel model = new ProductModel();
    List<ProductIngredientModel> product_ingredients = new List<ProductIngredientModel>();

    bool is_loading, show_modal;

    int product_portion_id = 0;

    protected override async Task OnInitializedAsync()
    {

        is_loading = true;
        await LoadData();
        is_loading = false;
    }

    public async Task LoadData()
    {
        is_loading = true;

        if (product_id > 0)
        { 
            var resp = await http.ApiGet($"Product({product_id})?$select=id&$expand=product_portions,product_ingredients");
            if (resp.IsSuccess)
            {
                model = JsonSerializer.Deserialize<ProductModel>(resp.Content.ToString()); 
            }
        }
        is_loading = false; 
    }

    public async Task OnSave()
    {
        show_modal = false;
        await LoadData();
    }

     void OnShowModal(List<ProductIngredientModel> _product_ingredients, int _product_portion_id)
    {
        product_portion_id = _product_portion_id;
        product_ingredients = _product_ingredients;
        show_modal = true;
        
    }

    
}
