@inject IHttpService http
@inject IMatToaster toast
<UIGridCenter>
@foreach(var pp in product_potions){
    <UIContainerBox Title="@pp.portion_name" 
        is_show_add_button="@(!pp.product_ingredients.Where(r=>r.is_deleted==false).Any())"
        is_show_edit_button="@pp.product_ingredients.Where(r=>r.is_deleted == false).Any()"
        OnAddClick="@(()=>OnShowModal(pp.product_ingredients, pp.id))"
        OnEditClick="@(()=>OnShowModal(pp.product_ingredients, pp.id))">

        <table class="uk-table  view_table set-verticle-middle uk-table-small uk-table-striped uk-table-hover">
            <tr>
                <ThAuto>Ingredient Name</ThAuto>
                <ThCenter>Quantity</ThCenter>
                <ThCenter>Unit</ThCenter>
                <ThRight>Cost</ThRight>
                <ThRight>Total Cost</ThRight>
            </tr>

            @if(pp.product_ingredients.Where(r=>r.is_deleted== false).Any()){
                foreach(var pi in pp.product_ingredients.Where(r=>r.is_deleted== false).ToList())
                {
                    <tr>
                        <td>
                            @pi.ingredient?.product_display_name
                        </td>
                        <TdCenter>
                            @pi.quantity
                        </TdCenter>
                        <TdCenter>@pi.unit</TdCenter>
                        <TdRight>@pi.cost.ToString(gv.currency_format)</TdRight>
                        <TdRight>@pi.total_cost.ToString(gv.currency_format)</TdRight>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="5">
                    <ComEmptyTemplate padding_top_bottom="25px"/>
                    </td>
                </tr>
            }
        </table>
    </UIContainerBox>
    <Spacing Number="25"/>
    }
</UIGridCenter>
<Com is_visible="@show_modal">
    <ComProductDetail_AddIngredientProduct  @bind-is_open="@show_modal" Save_Click="OnSave"   product_portion="@product_portion" />
</Com>
@code {
    [CascadingParameter] public GlobalVariableModel gv { get; set; }
    [Parameter] public int product_id { get; set; } 
    List<ProductPortionModel> product_potions = new List<ProductPortionModel> ();
    List<ProductIngredientModel> ingredients = new List<ProductIngredientModel>();
    ProductPortionModel product_portion = new ProductPortionModel();
    bool is_loading, show_modal;
    
    int product_portion_id = 0; 

    protected override async Task OnInitializedAsync()
    {

        is_loading = true;
        await LoadData();
        is_loading = false;
    }

    public async Task LoadData()
    {
        is_loading = true;

        if (product_id > 0)
        { 
            var resp = await http.ApiGet($"ProductPortion?$expand=product_ingredients($expand=ingredient($select=id,product_code,product_name_en,product_name_kh))&$filter=product_id eq {product_id}");
            if (resp.IsSuccess)
            {
                product_potions = JsonSerializer.Deserialize<List<ProductPortionModel>>(resp.Content.ToString()); 
            }
        }
        is_loading = false; 
    }

    public async Task OnSave()
    {
        show_modal = false;
        await LoadData();
    }

     void OnShowModal(ProductPortionModel _product_portion)
    {
        product_portion = _product_portion;
        show_modal = true;
        
    }

    
}
