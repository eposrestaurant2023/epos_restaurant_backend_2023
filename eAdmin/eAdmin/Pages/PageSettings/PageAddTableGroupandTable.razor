@page "/tablegroupandtable/{business_branch_id}/new"
@page "/tablegroupandtable/edit/{business_branch_id}/{id:int}"
@inherits PageCore

<Loading is_loading="@is_loading" />
@if (!is_loading)
{
    <Title Value="@lang["Table Group & Table"]"></Title>
    <PageContainer roles="@gv.GetRole("table_group_table")">
        <PageHeader>
            <HeaderLeft>
                <PageTitle ShowFilter="false">
                    <HeaderTemplate>
                        <div>@(id > 0 ? lang["Edit"] : lang["New"])  @lang["Table Group & Table"] @business_branch.business_branch_name_en</div>
                    </HeaderTemplate>
                </PageTitle>
            </HeaderLeft>
            <HeaderRight ShowBackButton="true" />
        </PageHeader>
        <EditForm Model="@model" OnValidSubmit="@Save_Click" @attributes="@formAttributes">
            <DataAnnotationsValidator />
            <PageBody>
                <UIGridCenter>
                    <UIContainerBox Title="@lang["Photo"]" ClassName="uk-text-center">
                        <UIFlexCenter>
                            <FileUpload @bind-ImageUrl="@model.photo" />
                        </UIFlexCenter>
                    </UIContainerBox>
                    <UIContainerBox Title="@lang["Table Group Information"]">
                        <TextInput @bind-text="@model.table_group_name_en" label="@lang["Name En"]">
                            <ValidationMessage For="@(() => model.table_group_name_en )" />
                        </TextInput>
                        <TextInput @bind-text="@model.table_group_name_kh" label="@lang["Name Kh"]" />
                        <SelectOutlet show_empty="true" selected_valueChanged="@OnOutletChanged" @bind-outlet="@model.outlet" business_branch_id="@business_branch.id">
                            <ValidationMessage For="@(() => model.outlet_id)" />
                        </SelectOutlet>
                        <ComInputCheckBox @bind-value="@model.status" label="@lang["Status"]" />
                    </UIContainerBox>
                    <UIContainerBox Title="@lang["Table Information"]">
                        <div class="uk-child-width-1-2 uk-grid-small" uk-grid>
                            <div>
                                <NumberInputInt label="@lang["Min"]" @bind-text="@min" placeholder="@lang["Min"]" />
                            </div>
                            <div>
                                <NumberInputInt label="@lang["Max"]" @bind-text="@max" placeholder="@lang["Max"]" />
                            </div>
                        </div>
                        <div class="uk-child-width-1-2 uk-grid-small" uk-grid>
                            <div>
                                <NumberInputDouble label="@lang["Width"]" @bind-text="@width" />
                            </div>
                            <div>
                                <NumberInputDouble label="@lang["Height"]" @bind-text="@height" />
                            </div>
                        </div>
                        <div class="uk-child-width-1-2 uk-grid-small" uk-grid>
                            <div>
                                <TextInput label="@lang["Prefix"]" @bind-text="@prefix" placeholder="@lang["Prefix"]" />
                            </div>
                            <div>
                                <TextInput label="@lang["Format"]" @bind-text="@number_format" placeholder="@lang["Format"]" />
                            </div>
                        </div>
                        <div>
                            <SelectSaleType show_empty="true" label="@lang["Sale Type"]" @bind-selected_value="@sale_type"/>
                        </div>
                        <Spacing Number="10" />
                        <div class="uk-width-1">
                            <Button type="button" OnClick="@Add_Table">@lang["Add Table"]</Button>
                        </div>
                        <Spacing Number="10" />
                        <div class="uk-overflow-auto table-scroll">
                            <table class="uk-table  view_table set-verticle-middle uk-table-small uk-table-striped uk-table-hover">
                                <tr>
                                    <ThAuto>@lang["Table #"]</ThAuto>
                                    <ThCenter width="100px">@lang["Width"]</ThCenter>
                                    <ThCenter width="100px">@lang["Height"]</ThCenter>
                                    <th>@lang["Shape"]</th>
                                    <th>@lang["Disc. Type"]</th>
                                    <th>@lang["Disc. Value"]</th>
                                    <th>@lang["Price Rule"]</th>
                                    <Th>@lang["Sale Type"]</Th>
                                    @if (is_table_require_check_in)
                                    {
                                        <Th>@lang["Require Check In"]</Th>

                                    }
                                    <ThCenter>@lang["Sort Order"]</ThCenter>
                                    <Th></Th>
                                    <Th></Th>
                                </tr>
                                <tr>
                                    <ThAuto>@lang["Apply All"]</ThAuto>
                                    <ThCenter>
                                        <NumberInputDouble @bind-text="@width" />
                                    </ThCenter>
                                    <ThCenter>
                                        <NumberInputDouble @bind-text="@height" />
                                    </ThCenter>
                                    <th>
                                        <SelectShape @bind-selected_value="@shape" />
                                    </th>
                                    <ThCenter colspan="2"> - </ThCenter>
                                    <th>
                                        <SelectPriceRule @bind-selected_value="@price_rule" outlet="@model.outlet" is_inline="true" show_empty="true" width="100px" />
                                    </th>
                                    <Th>
                                        <SelectSaleType @bind-selected_value="@sale_type" show_empty="true" width="100px" is_horizontal="false" is_inline="true" />
                                    </Th>

                                    @if (is_table_require_check_in)
                                    {
                                        <Th>
                                            <ComInputCheckBox @bind-value="require_check_in" />
                                        </Th>
                                    }

                                    <Th></Th>
                                    <th></th>
                                    <th></th>
                                </tr>
                                @foreach (var s in model.tables.Where(r => r.is_deleted == false).OrderBy(r=>r.sort_order).ToList())
                                {
                            <tr>
                                <td>
                                    <TextInput label="" @bind-text="@s.table_name" />
                                </td>
                                <TdCenter>
                                    <NumberInputDouble @bind-text="@s.width" />
                                </TdCenter>
                                <TdCenter>
                                    <NumberInputDouble @bind-text="@s.height" />
                                </TdCenter>
                                <td>
                                    <SelectShape @bind-selected_value="@s.shape" />
                                </td>
                                <td>
                                    <SelectDiscountType @bind-selected_value="@s.discount_type"></SelectDiscountType>
                                </td>
                                <TdCenter>
                                    <NumberInputDecimal @bind-text="@s.discount_value" />                                    
                                </TdCenter>
                                <td>
                                    <SelectPriceRule @bind-selected_value="@s.price_rule_id" outlet="@model.outlet" is_inline="true" show_empty="true" width="100px" />
                                </td>
                                <td>
                                    <SelectSaleType @bind-selected_value="@s.sale_type" is_horizontal="false" width="50px" is_inline="true" show_empty="true" />
                                </td>
                                @if (is_table_require_check_in)
                                {
                                    <td>
                                        <ComInputCheckBox @bind-value="s.require_check_in" />
                                    </td>
                                }

                                <TdCenter>
                                    <NumberInputInt @bind-text="@s.sort_order" />
                                </TdCenter>

                                <td>
                                    <LabelActive OnClick="@(() => Activebutton(s))" is_visible="@s.status" />
                                    <LabelInActive OnClick="@(() => Activebutton(s))" is_visible="@(!s.status)" />
                                </td>
                                <td>
                                    <Icon icon="delete" OnClick="@(()=>Delete_Table(s))" />
                                </td>
                            </tr>
                                }
                            </table>
                            <Spacing Number="4"/>
                            <Button OnClick="@AddNewTable">@lang["Add Table"]</Button>
                        </div>
                    </UIContainerBox>
                </UIGridCenter>
            </PageBody>
            <PageFooter>
                <FooterCenter>
                    <ComSavingFormButton is_loading="@is_saving" cancel_url="tablegroupandtable" />
                </FooterCenter>
            </PageFooter>
        </EditForm>
    </PageContainer>

}

@code{
    [Parameter] public int id { get; set; } = 0;
    [Parameter] public string business_branch_id { get; set; }
    TableGroupModel model = new TableGroupModel();
    BusinessBranchModel business_branch { get; set; }
    bool is_table_require_check_in = false;
    string prefix = "T";
    string number_format = "00";
    int min = 1;

    int max = 10;
    Guid outlet_id = Guid.Empty;

    string ControllerApi = "TableGroup";


    private double _height = 60;
    public double height
    {
        get { return _height; }
        set
        {
            _height = value;
            model.tables.ForEach(r => r.height = _height);
        }
    }

    private double _width = 60;
    public double width
    {
        get { return _width; }
        set
        {
            _width = value;
            model.tables.ForEach(r => r.width = _width);
        }
    }

    private int? _price_rule;
    public int? price_rule
    {
        get { return _price_rule; }
        set
        {
            _price_rule = value;
            model.tables.ForEach(r => r.price_rule_id = _price_rule);
        }
    }

    private string? _sale_type;

    public string? sale_type
    {
        get { return _sale_type; }
        set
        {
            _sale_type = value;
            model.tables.ForEach(r => r.sale_type = _sale_type);
        }
    }

    private bool _require_check_in;

    public bool require_check_in
    {
        get { return _require_check_in; }
        set
        {
            _require_check_in = value;
            model.tables.ForEach(r => r.require_check_in = _require_check_in);
        }
    }


    private string? _shape = "Rectangle";

    public string? shape
    {
        get { return _shape; }
        set
        {
            _shape = value;
            model.tables.ForEach(r => r.shape = _shape);
        }
    }


    protected override async Task OnInitializedAsync()
    {
        is_loading = true;
        @if (id > 0)
        {
            await LoadData();
        }
        else
        {
            business_branch = gv.bussiness_branches.Where(r => r.id == Guid.Parse(business_branch_id)).FirstOrDefault();
        }
        //get is table require check in feature
        is_table_require_check_in =  gv.business_branch_has_feature(business_branch_id,"CHIO");

        is_loading = false;
    }



    async Task LoadData()
    {
        is_loading_data = true;
        string api_url = ControllerApi;
        api_url += $"({id})?";
        api_url += "$expand=outlet($select=id,outlet_name_en,outlet_name_kh,business_branch_id;$expand=business_branch";
        api_url += "($select=id,business_branch_name_en,business_branch_name_kh);$filter= is_deleted  eq false),";
        api_url +=  "tables($select = id,sort_order,table_name,height,width,position_x_percent,sale_type,shape,position_y_percent,price_rule_id,require_check_in,status,default_discount_percentage;";
        api_url += "$filter= is_deleted eq false;$orderby=sort_order desc)";


        var resp = await http.ApiGet(api_url);
        if (resp.IsSuccess)
        {
            model = JsonSerializer.Deserialize<TableGroupModel>(resp.Content.ToString());
            business_branch = model.outlet.business_branch;
        }
        is_loading_data = false;
    }

    async Task Save_Click(EditContext editContext)
    {
        if (model.outlet_id == Guid.Empty)
        {
            toast.Add(lang["Please select outlet"], MudBlazor.Severity.Warning);
            is_saving = false;
            return;
        }


        if (!is_saving)
        {
            is_saving = true;
            TableGroupModel save_table_group = JsonSerializer.Deserialize<TableGroupModel>(JsonSerializer.Serialize(model));


            save_table_group.outlet = null;
            var res = await http.ApiPost($"{ControllerApi}/save", save_table_group);
            if (res.IsSuccess)
            {
                toast.Add(lang["Saving successfully"], MudBlazor.Severity.Success);
                nav.NavigateTo($"tablegroupandtable");
            }
            else
            {
                is_saving = false;
                Console.WriteLine(res.Content.ToString());
                toast.Add(res.Content.ToString(), MudBlazor.Severity.Warning);
            }
            is_saving = false;
        }
    }


    void Add_Table()

    {
        if (min > max)
        {
            toast.Add(lang["Please enter valid Min and Max number"], MudBlazor.Severity.Warning);
            return;
        }
        while (min <= max)
        {
            model.tables.Add(new TableModel()
            {
                table_name = prefix + min.ToString(number_format),
                width = width,
                height = height,
                shape = shape,
                sort_order = model.tables.Count() +1
            });
            min = min + 1;
        }
    }

    void AddNewTable(){
        model.tables.Add(new TableModel()
        {
            table_name = (model.tables.Where(r=>r.is_deleted==false).Count()+ 1).ToString("00"),

            sort_order = model.tables.Where(r=>r.is_deleted==false).Count()+ 1
        });
    }

    void Delete_Table(TableModel s)
    {
        if (s.id == 0)
        {
            model.tables.Remove(s);
        }
        else
        {
            s.is_deleted = true;
        }
    }

    void Activebutton(TableModel t)
    {
        t.status = !t.status;
    }


    void OnOutletChanged(Guid? id){
        model.outlet_id = id ?? Guid.Empty;
    }

}
